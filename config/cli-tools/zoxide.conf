# zoxide configuration
# Smart directory jumping based on frequency and recency

# Environment variables for zoxide
export _ZO_ECHO=1          # Print the matched directory before navigating
export _ZO_RESOLVE_SYMLINKS=1  # Resolve symlinks when adding to database

# Zoxide configuration
# Note: zoxide init is called in the main aliases file

# Useful zoxide functions and aliases
if command -v zoxide >/dev/null 2>&1; then
    # Advanced zoxide functions
    zoxide_top() {
        # Show top directories by frequency
        zoxide query --list --score | head -20
    }

    zoxide_clean() {
        # Remove invalid directories from database
        echo "Cleaning zoxide database..."
        zoxide query --list | while read -r dir; do
            if [[ ! -d "$dir" ]]; then
                echo "Removing invalid directory: $dir"
                zoxide remove "$dir"
            fi
        done
    }

    zoxide_stats() {
        # Show database statistics
        echo "Zoxide database statistics:"
        echo "Total entries: $(zoxide query --list | wc -l)"
        echo ""
        echo "Top 10 directories:"
        zoxide query --list --score | head -10
    }

    zoxide_backup() {
        # Backup zoxide database
        local backup_file="$HOME/.zoxide_backup_$(date +%Y%m%d_%H%M%S).txt"
        zoxide query --list > "$backup_file"
        echo "Zoxide database backed up to: $backup_file"
    }

    zoxide_import() {
        # Import directories from a backup file
        if [[ $# -ne 1 ]]; then
            echo "Usage: zoxide_import <backup_file>"
            return 1
        fi

        if [[ ! -f "$1" ]]; then
            echo "Backup file not found: $1"
            return 1
        fi

        while read -r dir; do
            if [[ -d "$dir" ]]; then
                zoxide add "$dir"
            fi
        done < "$1"
        echo "Imported directories from: $1"
    }

    # Enhanced aliases
    alias zt='zoxide_top'
    alias zc='zoxide_clean'
    alias zs='zoxide_stats'
    alias zb='zoxide_backup'
    # zi function defined below if fzf is available, otherwise alias to zoxide_import

    # Quick navigation aliases
    alias zh='z ~'              # Go home
    alias zd='z ~/Downloads'    # Go to downloads
    alias zw='z ~/workspace'    # Go to workspace
    alias zp='z ~/projects'     # Go to projects
    alias zt='z /tmp'           # Go to temp

    # Interactive selection with preview (if fzf is available)
    if command -v fzf >/dev/null 2>&1; then
        zoxide_interactive() {
            local dir
            dir=$(zoxide query --list --score | sort -rn | fzf --height 40% --reverse --preview 'ls -la {2}' --preview-window=right:50% | cut -d' ' -f2-)
            if [[ -n "$dir" ]]; then
                cd "$dir" || return 1
            fi
        }
    else
        # Fallback to import function when fzf is not available
        alias zi='zoxide_import'
    fi

    # Project-specific navigation
    project() {
        # Navigate to a project directory
        local project_dir
        if [[ -d "$HOME/workspace" ]]; then
            project_dir="$HOME/workspace"
        elif [[ -d "$HOME/projects" ]]; then
            project_dir="$HOME/projects"
        elif [[ -d "$HOME/dev" ]]; then
            project_dir="$HOME/dev"
        else
            project_dir="$HOME"
        fi

        if [[ $# -eq 0 ]]; then
            z "$project_dir"
        else
            z "$project_dir/$1"
        fi
    }

else
    # Fallback functions for systems without zoxide
    alias z='cd'
    alias zi='cd'
    alias zh='cd ~'
    alias zd='cd ~/Downloads'
    alias zw='cd ~/workspace 2>/dev/null || cd ~/projects 2>/dev/null || cd ~'
    alias zp='cd ~/projects 2>/dev/null || cd ~/workspace 2>/dev/null || cd ~'
    alias zt='cd /tmp'

    zoxide_top() {
        echo "Zoxide not available. Install zoxide for smart directory navigation."
    }

    project() {
        if [[ $# -eq 0 ]]; then
            cd ~/workspace 2>/dev/null || cd ~/projects 2>/dev/null || cd ~
        else
            cd ~/workspace/"$1" 2>/dev/null || cd ~/projects/"$1" 2>/dev/null || cd ~/"$1"
        fi
    }
fi

# Integration with other tools
if command -v fzf >/dev/null 2>&1 && command -v zoxide >/dev/null 2>&1; then
    # FZF integration for directory selection
    export FZF_ALT_C_COMMAND='zoxide query --list'
    export FZF_ALT_C_OPTS="--preview 'tree -C {} | head -200'"
fi
