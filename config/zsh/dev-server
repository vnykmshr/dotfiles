# Development Server Automation

# Detect and run development server
dev() {
    # Go projects
    if [[ -f "go.mod" ]]; then
        if [[ -f "main.go" ]]; then
            go run .
        elif [[ -d "cmd" ]]; then
            go run ./cmd/...
        else
            echo "No main.go or cmd/ found"
            return 1
        fi
        return
    fi

    # Node.js projects
    if [[ -f "package.json" ]]; then
        if command -v jq >/dev/null && jq -e '.scripts.dev' package.json >/dev/null 2>&1; then
            npm run dev
        elif command -v jq >/dev/null && jq -e '.scripts.start' package.json >/dev/null 2>&1; then
            npm start
        else
            echo "No dev or start script in package.json"
            return 1
        fi
        return
    fi

    # Python projects
    if [[ -f "manage.py" ]]; then
        python manage.py runserver
        return
    fi

    # Makefile projects
    if [[ -f "Makefile" ]]; then
        if grep -q "^dev:" Makefile; then
            make dev
        elif grep -q "^serve:" Makefile; then
            make serve
        elif grep -q "^start:" Makefile; then
            make start
        else
            echo "No dev/serve/start target in Makefile"
            return 1
        fi
        return
    fi

    echo "No development server configuration found"
    return 1
}

# Show available dev server options
devinfo() {
    echo "Development server options:"

    [[ -f "go.mod" ]] && echo "  Go: go run ."

    if [[ -f "package.json" ]] && command -v jq >/dev/null; then
        local scripts=$(jq -r '.scripts | keys[]' package.json 2>/dev/null | grep -E "(dev|start)" | head -3)
        [[ -n "$scripts" ]] && echo "  Node.js: npm run {$(echo $scripts | tr '\n' ',' | sed 's/,$//')}"
    fi

    [[ -f "manage.py" ]] && echo "  Django: python manage.py runserver"

    if [[ -f "Makefile" ]]; then
        local targets=$(grep -E "^(dev|serve|start):" Makefile | cut -d: -f1 | head -3)
        [[ -n "$targets" ]] && echo "  Make: make {$(echo $targets | tr '\n' ',' | sed 's/,$//')}"
    fi
}
