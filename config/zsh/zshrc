# Modern Zsh Configuration - Clean Version

# Performance and debug mode
[[ "$ZSH_PROF" == "1" ]] && zmodload zsh/zprof
[[ "$DOTFILES_DEBUG" == "true" ]] && zmodload zsh/zprof

# Core configuration
export DOTFILES="${DOTFILES:-$HOME/.dotfiles}"

# Verify .dotfiles symlink exists (setup.sh should create it)
if [[ ! -L "$HOME/.dotfiles" ]]; then
    echo "⚠️  Warning: ~/.dotfiles symlink not found. Run 'make install' to set up dotfiles properly." >&2
fi

export HISTFILE="$HOME/.zsh_history"
export HISTSIZE=50000 SAVEHIST=50000

# History options (essential only)
setopt EXTENDED_HISTORY HIST_IGNORE_ALL_DUPS HIST_IGNORE_SPACE
setopt HIST_REDUCE_BLANKS INC_APPEND_HISTORY SHARE_HISTORY

# Navigation and globbing
setopt AUTO_CD AUTO_PUSHD PUSHD_IGNORE_DUPS PUSHD_SILENT
setopt EXTENDED_GLOB GLOB_DOTS

# Other essentials
setopt INTERACTIVE_COMMENTS PROMPT_SUBST

# Environment
export EDITOR="${EDITOR:-nvim}" VISUAL="$EDITOR" PAGER="${PAGER:-less}"
export LESS='-R -i -w -M -z-4' LESSHISTFILE=/dev/null
export LANG="${LANG:-en_US.UTF-8}" LC_ALL="${LC_ALL:-en_US.UTF-8}"

# Path configuration
typeset -U path PATH
path=(
    "$HOME/.local/bin"
    "$HOME/bin"
    "$DOTFILES/bin"
    "$HOME/.cargo/bin"
    $path
)

# Add brew paths if they exist
for brew_path in "/opt/homebrew/bin" "/usr/local/bin"; do
    [[ -d "$brew_path" ]] && path=("$brew_path" $path)
done

# Load configuration modules
load_config() {
    local config_path="$DOTFILES/config/zsh/$1"
    [[ -r "$config_path" ]] && source "$config_path"
}

# Load core modules (always needed)
for module in exports aliases functions dev-automation; do
    load_config "$module"
done

# Load user customizations
load_config "personal-aliases"
load_config "personal-functions"

# Load optional modules (can be disabled)
[[ "$DOTFILES_SKIP_CROSS_PLATFORM" != "1" ]] && load_config "cross-platform"
[[ "$DOTFILES_SKIP_ENV_DETECTION" != "1" ]] && load_config "environment-detection"
[[ "$DOTFILES_SKIP_DIRENV" != "1" ]] && load_config "direnv-integration"
[[ "$DOTFILES_SKIP_HISTORY" != "1" ]] && load_config "intelligent-history"
[[ "$DOTFILES_SKIP_SECURITY" != "1" ]] && load_config "security-automation"
[[ "$DOTFILES_SKIP_PERFORMANCE" != "1" ]] && load_config "performance"

# Minimal prompt (or use starship if installed)
if command -v starship >/dev/null 2>&1; then
    eval "$(starship init zsh)"
else
    # Simple fallback: user@host:directory %
    PROMPT='%F{cyan}%n@%m%f:%F{blue}%~%f%# '
fi

# Load CLI tools and workflow automation
[[ -r "$DOTFILES/config/cli-tools/init" ]] && source "$DOTFILES/config/cli-tools/init"
[[ -r "$DOTFILES/config/workflow/init" ]] && source "$DOTFILES/config/workflow/init"

# Override any conflicting aliases with our functions (must be after CLI tools)
unalias cat 2>/dev/null || true  # cat() function defined in aliases

# Tool integrations (lazy load heavy ones)
# Brew shellenv - only run if brew works properly
if [[ -x "/usr/local/bin/brew" ]]; then
    # Test if brew can run without errors before eval
    if /usr/local/bin/brew --version >/dev/null 2>&1; then
        eval "$(/usr/local/bin/brew shellenv)"
    fi
elif [[ -x "/opt/homebrew/bin/brew" ]]; then
    if /opt/homebrew/bin/brew --version >/dev/null 2>&1; then
        eval "$(/opt/homebrew/bin/brew shellenv)"
    fi
fi

# Lazy load fzf
if command -v fzf >/dev/null 2>&1; then
    fzf() {
        unfunction fzf
        eval "$(command fzf --zsh)"
        fzf "$@"
    }
fi

# Completion system (optimized)
autoload -Uz compinit
if [[ -n ~/.zcompdump(#qN.mh+24) ]]; then
    compinit
else
    compinit -C
fi

# Essential completion options
setopt AUTO_MENU COMPLETE_IN_WORD MENU_COMPLETE

# Completion styles (minimal)
zstyle ':completion:*' matcher-list 'm:{a-zA-Z}={A-Za-z}'
zstyle ':completion:*' menu select
zstyle ':completion:*' use-cache yes cache-path ~/.zsh/cache

# Key bindings
bindkey -e
bindkey '^R' history-incremental-search-backward
bindkey '^P' history-search-backward
bindkey '^N' history-search-forward

# Debug output
[[ "$DOTFILES_DEBUG" == "true" ]] && zprof

# Personal/work configuration (not tracked by git)
load_config "personal.local"

# Local overrides
[[ -f ~/.zshrc.local ]] && source ~/.zshrc.local

# === ALIAS REMINDERS ===
[[ "$DOTFILES_SKIP_ALIAS_REMINDER" != "1" ]] && load_config "alias-reminder"
