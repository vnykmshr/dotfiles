# Security Automation

# =============================================================================
# Environment File Security
# =============================================================================

# Secure .env files
secure_env_files() {
    local env_files=(".env" ".env.local" ".env.development" ".env.production")
    local updated=false

    for env_file in "${env_files[@]}"; do
        [[ ! -f "$env_file" ]] && continue

        # Set secure permissions
        chmod 600 "$env_file" 2>/dev/null

        # Add to .gitignore if missing
        if [[ -f ".gitignore" ]] && ! grep -q "^${env_file}$" .gitignore 2>/dev/null; then
            echo "$env_file" >> .gitignore
            updated=true
        fi
    done

    [[ "$updated" == "true" ]] && echo "Updated .gitignore with environment files"
}

# Basic secret patterns for git hooks
get_secret_patterns() {
    echo "password\s*[=:]\s*['\"][^'\"]{8,}['\"]|secret\s*[=:]\s*['\"][^'\"]{16,}['\"]|token\s*[=:]\s*['\"][^'\"]{20,}['\"]|api[_-]?key\s*[=:]\s*['\"][^'\"]{16,}['\"]"
}

# Install basic git security hook
install_security_hooks() {
    local git_dir
    git_dir=$(git rev-parse --git-dir 2>/dev/null) || return
    local hook="$git_dir/hooks/pre-commit"

    [[ -f "$hook" ]] && return

    cat > "$hook" <<'EOF'
#!/bin/bash
# Basic security check
patterns="password\s*[=:]\s*['\"][^'\"]{8,}['\"]|secret\s*[=:]\s*['\"][^'\"]{16,}['\"]|token\s*[=:]\s*['\"][^'\"]{20,}['\"]"
if git diff --cached --name-only | xargs grep -lE "$patterns" 2>/dev/null; then
    echo "Potential secrets detected in commit"
    echo "Review files and remove sensitive data"
    exit 1
fi
EOF

    chmod +x "$hook"
}

# =============================================================================
# SSH Security
# =============================================================================

# Check SSH key permissions
check_ssh_security() {
    [[ ! -d "$HOME/.ssh" ]] && return

    echo "SSH Security Check:"

    # Check directory permissions
    local ssh_perms=$(stat -f "%Lp" "$HOME/.ssh" 2>/dev/null || stat -c "%a" "$HOME/.ssh" 2>/dev/null)
    [[ "$ssh_perms" != "700" ]] && echo "  Fix SSH dir: chmod 700 ~/.ssh"

    # Check private key permissions
    for key in "$HOME/.ssh"/id_*; do
        [[ ! -f "$key" || "$key" == *".pub" ]] && continue
        local perms=$(stat -f "%Lp" "$key" 2>/dev/null || stat -c "%a" "$key" 2>/dev/null)
        [[ "$perms" != "600" ]] && echo "  Fix key $key: chmod 600 $key"
    done
}

# =============================================================================
# Automatic Security
# =============================================================================

# Run security checks on directory change
security_check_on_cd() {
    git rev-parse --git-dir >/dev/null 2>&1 || return

    # Secure .env files if present
    setopt local_options nullglob
    local env_files=(.env*)
    if [[ ${#env_files[@]} -gt 0 ]]; then
        secure_env_files
    fi

    # Install git hooks if missing
    install_security_hooks
}

# =============================================================================
# Commands
# =============================================================================

alias seccheck='check_ssh_security'
alias envcheck='secure_env_files'
alias gitsec='install_security_hooks'

# =============================================================================
# Setup
# =============================================================================

autoload -U add-zsh-hook
add-zsh-hook chpwd security_check_on_cd
