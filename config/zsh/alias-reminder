#!/usr/bin/env zsh
# Alias reminder system - shows helpful aliases periodically

# Configuration - simple and self-contained
export ALIAS_REMINDER_ENABLED="${ALIAS_REMINDER_ENABLED:-true}"
export ALIAS_REMINDER_FREQUENCY="${ALIAS_REMINDER_FREQUENCY:-5}"
export ALIAS_REMINDER_DIR="$HOME/.config/dotfiles"
export ALIAS_REMINDER_COUNTER="$ALIAS_REMINDER_DIR/session-counter"

# Create directory if needed
[[ ! -d "$ALIAS_REMINDER_DIR" ]] && mkdir -p "$ALIAS_REMINDER_DIR"

# Simple alias collection - always available
declare -A HELPFUL_ALIASES=(
    # Navigation & File Management
    [".."]="cd .. (go up one directory)"
    ["..."]="cd ../.."
    ["ws"]="cd $HOME/workspace"
    ["proj"]="cd $HOME/workspace/projects"
    ["ll"]="ls -la with details"
    ["la"]="ls -la all files"
    ["lt"]="tree view (level 2)"
    ["lm"]="ls with pager"
    ["ducks"]="show largest directories"
    ["findbig"]="find 5 largest files"

    # Git Shortcuts
    ["gst"]="git status (you use this often!)"
    ["ga"]="git add"
    ["gc"]="git commit"
    ["gp"]="git push"
    ["gd"]="git diff"
    ["gup"]="git pull && submodule update"
    ["gcl"]="git clean -fd && reset --hard"
    ["mygh"]="enhanced git helpers"
    ["gsave"]="git save helper"

    # System Monitoring
    ["cpu"]="htop sorted by CPU usage"
    ["ports"]="show open network ports"
    ["conncount"]="count network connections by state"
    ["wotgobblemem"]="top 15 memory-consuming processes"
    ["memfree"]="show free memory"
    ["dskload"]="show disk I/O processes"
    ["psg"]="ps aux | grep"

    # Development Tools
    ["serve"]="python3 -m http.server"
    ["cls"]="clear screen"
    ["path"]="show PATH in readable format"
    ["curly"]="enhanced curl with timing details"
    ["vgrep"]="smart grep with fd + ripgrep"
    ["v"]="open in $EDITOR"

    # Network & Web
    ["get"]="curl with progress bar"
    ["header"]="curl headers only"
    ["ping"]="ping with 5 packets"
    ["fastping"]="ping 100 packets"

    # Safety & Utilities
    ["rm"]="rm -i (interactive deletion)"
    ["cp"]="cp -i (interactive copy)"
    ["mv"]="mv -i (interactive move)"
    ["df"]="df -h (human readable)"
    ["du"]="du -h (human readable)"
    ["reload"]="source ~/.zshrc"

    # Typo Protection
    ["shh"]="ssh (common typo fix)"
    ["sduo"]="sudo (typo fix)"
    ["suod"]="sudo (typo fix)"
)

increment_session_counter() {
    local count=0
    [[ -f "$ALIAS_REMINDER_COUNTER" ]] && count=$(cat "$ALIAS_REMINDER_COUNTER")
    echo $((count + 1)) > "$ALIAS_REMINDER_COUNTER"
    echo $((count + 1))
}

should_show_reminder() {
    local session_count
    session_count=$(increment_session_counter)
    (( session_count % ALIAS_REMINDER_FREQUENCY == 0 ))
}

# Simple, reliable reminder function
show_reminders() {
    local -a keys=("${(@k)HELPFUL_ALIASES}")
    local -a selected=()
    local max_tips=3

    # Randomly select unique aliases
    while [[ ${#selected[@]} -lt $max_tips && ${#keys[@]} -gt 0 ]]; do
        local idx=$(( (RANDOM % ${#keys[@]}) + 1 ))
        local key="${keys[$idx]}"
        selected+=("$key")
        keys=("${keys[@]:#$key}")  # Remove selected key
    done

    [[ ${#selected[@]} -eq 0 ]] && return

    printf "\n💡 Alias Reminders (%d tips)\n" ${#selected[@]}
    echo "════════════════════════════════════════"

    for alias_name in "${selected[@]}"; do
        printf "%-15s %s\n" "$alias_name" "${HELPFUL_ALIASES[$alias_name]}"
    done

    printf "\n💡 Try these shortcuts! Use 'ar-show' for more.\n\n"
}

# Management commands
alias-reminder-show() {
    local -a keys=("${(@k)HELPFUL_ALIASES}")
    local -a selected=()
    local max_tips=5

    # Randomly select unique aliases
    while [[ ${#selected[@]} -lt $max_tips && ${#keys[@]} -gt 0 ]]; do
        local idx=$(( (RANDOM % ${#keys[@]}) + 1 ))
        local key="${keys[$idx]}"
        selected+=("$key")
        keys=("${keys[@]:#$key}")  # Remove selected key
    done

    [[ ${#selected[@]} -eq 0 ]] && return

    printf "\n💡 Alias Reminders (%d tips)\n" ${#selected[@]}
    echo "════════════════════════════════════════"

    for alias_name in "${selected[@]}"; do
        printf "%-15s %s\n" "$alias_name" "${HELPFUL_ALIASES[$alias_name]}"
    done

    printf "\n💡 Try these shortcuts to speed up your workflow!\n"
    printf "   Show more: ar-show  |  Disable: ar-off  |  Enable: ar-on\n\n"
}
alias-reminder-disable() { export ALIAS_REMINDER_ENABLED=false; echo "Alias reminders disabled"; }
alias-reminder-enable() { export ALIAS_REMINDER_ENABLED=true; echo "Alias reminders enabled"; }
alias-reminder-reset() { rm -f "$ALIAS_REMINDER_COUNTER"; echo "Session counter reset"; }

# Short aliases
alias ar-show='alias-reminder-show'
alias ar-on='alias-reminder-enable'
alias ar-off='alias-reminder-disable'
alias ar-reset='alias-reminder-reset'

# Function to check and show reminders (can be called manually or via hooks)
check_reminders() {
    [[ "$ALIAS_REMINDER_ENABLED" == "true" ]] && should_show_reminder && show_reminders
}

# Hook into zsh's command cycle to show reminders periodically
alias_reminder_hook() {
    check_reminders
}

# Auto-run in interactive shells and set up hooks
if [[ $- == *i* && "$ALIAS_REMINDER_ENABLED" == "true" ]]; then
    # Try to add to precmd hooks
    if command -v add-zsh-hook >/dev/null 2>&1; then
        add-zsh-hook precmd alias_reminder_hook 2>/dev/null
    fi

    # Also provide manual trigger
    alias check-reminders='check_reminders'
fi
